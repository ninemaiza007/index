    let holidays = {};
    let currentFetchedYear = null;

    async function fetchHolidays(year) {
        if (currentFetchedYear === year) {
            renderCalendar();
            return;
        }
        
        try {
            // ดึงข้อมูลวันหยุด
            const res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/TH`);
            if (!res.ok) throw new Error('Network response was not ok');
            
            const data = await res.json();
            holidays = {}; 
            
            data.forEach(h => {
                // แปลง format ให้เป็น YYYY-M-D (ไม่มีเลข 0 นำหน้า) เพื่อให้ตรงกับ key ใน render
                const d = new Date(h.date);
                const key = `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
                holidays[key] = h.localName;
            });
            
            console.log("Holidays loaded:", holidays); // เช็คใน Console ว่าข้อมูลมาไหม
            currentFetchedYear = year;
            renderCalendar();
        } catch (err) {
            console.error("Fetch error:", err);
            // ถ้า API ล่ม ให้ใส่ข้อมูลเบื้องต้นไว้กันพลาด
            if(year === 2026) {
                holidays["2026-1-1"] = "วันขึ้นปีใหม่";
                holidays["2026-3-3"] = "วันมาฆบูชา";
                holidays["2026-4-6"] = "วันจักรี";
                holidays["2026-4-13"] = "วันสงกรานต์";
            }
            renderCalendar();
        }
    }

    // แก้ไขฟังก์ชัน renderCalendar ตรงจุดที่สร้าง key
    function renderCalendar() {
        const selectedMonth = parseInt(monthSelect.value);
        const selectedYear = parseInt(yearSelect.value);
        const today = new Date();

        const firstDay = new Date(selectedYear, selectedMonth, 1).getDay();
        const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
        const grid = document.getElementById('calendar-days');
        grid.innerHTML = "";

        // ... (ส่วนหัววัน อา.-ส. เหมือนเดิม) ...
        const dayNames = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
        dayNames.forEach(d => grid.innerHTML += `<div class="day-label">${d}</div>`);
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="day-cell empty"></div>`;

        for (let i = 1; i <= daysInMonth; i++) {
            // KEY ต้องตรงกับที่เก็บใน holidays
            const key = `${selectedYear}-${selectedMonth + 1}-${i}`;
            const isToday = (i === today.getDate() && selectedMonth === today.getMonth() && selectedYear === today.getFullYear()) ? 'today' : '';
            
            const holidayName = holidays[key] ? `<div class="holiday-tag">${holidays[key]}</div>` : '';

            grid.innerHTML += `
                <div class="day-cell ${isToday}">
                    <span class="date-num">${i}</span>
                    ${holidayName}
                </div>`;
        }
    }
